{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4 text-center">Student Performance Summary</h2>

    <!-- Alert Buttons -->
    <div class="d-flex justify-content-center gap-3 mb-4">
        <form action="{{ url_for('teacher.send_low_grade_alerts') }}" method="post">
            <button class="btn btn-warning" type="submit">Send Low Score Alerts</button>
        </form>
        <form action="{{ url_for('teacher.send_attendance_alerts') }}" method="post">
            <button class="btn btn-warning" type="submit">Send Attendance Alerts</button>
        </form>
    </div>

    <!-- Charts -->
    <div class="row mb-4">
        <div class="col-md-6">
            <canvas id="gradeChart"></canvas>
        </div>
        <div class="col-md-6">
            <canvas id="attendanceChart"></canvas>
        </div>
    </div>

    <!-- Filters + Summary -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="d-flex gap-3">
                <input type="text" id="studentNameFilter" class="form-control" placeholder="Search by student name">
                <select id="gradeFilter" class="form-select w-auto">
                    <option value="">All Grades</option>
                    <option value="Excellent">Excellent</option>
                    <option value="Good">Good</option>
                    <option value="Average">Average</option>
                    <option value="Low">Low</option>
                </select>
            </div>
        </div>
        <div class="col-md-4 mt-3 mt-md-0">
            <div class="card">
                <div class="card-header bg-primary text-white">Performance Summary</div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li><strong>Total Students:</strong> {{ performance_records|length }}</li>
                        <li><strong>Low:</strong> {{ grade_counts['Low'] }}</li>
                        <li><strong>Average:</strong> {{ grade_counts['Average'] }}</li>
                        <li><strong>Good:</strong> {{ grade_counts['Good'] }}</li>
                        <li><strong>Excellent:</strong> {{ grade_counts['Excellent'] }}</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Table -->
    <h4 class="mt-5">Performance Table</h4>
    <table class="table table-striped text-center">
        <thead class="table-dark">
            <tr>
                <th>Name</th>
                <th>Predicted Semester 3 Score</th>
                <th>Attendance (%)</th>
                <th>Grade</th>
            </tr>
        </thead>
        <tbody>
            {% for record in performance_records %}
            <tr class="performance-row" data-name="{{ record.name | lower }}" data-grade="{{ record.grade | lower }}">
                <td>{{ record.name }}</td>
                <td>{{ record.score }}</td>
                <td>{{ record.attendance }}</td>
                <td>{{ record.grade }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Grade Chart
    const gradeCounts = {{ grade_counts | tojson }};
    const gradeCtx = document.getElementById('gradeChart').getContext('2d');
    new Chart(gradeCtx, {
        type: 'bar',
        data: {
            labels: Object.keys(gradeCounts),
            datasets: [{
                label: 'Performance Categories',
                data: Object.values(gradeCounts),
                backgroundColor: ['#e74c3c', '#f39c12', '#3498db', '#2ecc71']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Performance Category Distribution'
                }
            }
        }
    });

    // Attendance Chart
    const attendanceGroups = {{ attendance_groups | tojson }};
    const attendanceCtx = document.getElementById('attendanceChart').getContext('2d');
    new Chart(document.getElementById('attendanceChart').getContext('2d'), {
    type: 'pie',
    data: {
        labels: ['Below 75%', '76-80%', '81-90%', '91-99%'],
        datasets: [{
            data: [
                attendanceGroups['Below 75%'],
                attendanceGroups['76-80%'],
                attendanceGroups['81-90%'],
                attendanceGroups['91-99%']
            ],
            backgroundColor: ['#FF0000', '#FF8000', '#00FF00', '#008000'],
            borderColor: ['#FF0000', '#FF8000', '#00FF00', '#008000'],
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        plugins: {
            title: {
                display: true,
                text: 'Semester 3 Attendance Distribution'
            },
            tooltip: {
                callbacks: {
                    label: function(tooltipItem) {
                        return tooltipItem.label + ': ' + tooltipItem.raw + ' students';
                    }
                }
            }
        }
    }
});


    // Filter Logic
    document.getElementById('studentNameFilter').addEventListener('input', function () {
        const term = this.value.toLowerCase();
        document.querySelectorAll('.performance-row').forEach(row => {
            const nameMatch = row.dataset.name.includes(term);
            const grade = document.getElementById('gradeFilter').value.toLowerCase();
            const gradeMatch = !grade || row.dataset.grade === grade;
            row.style.display = (nameMatch && gradeMatch) ? '' : 'none';
        });
    });

    document.getElementById('gradeFilter').addEventListener('change', function () {
        const grade = this.value.toLowerCase();
        const term = document.getElementById('studentNameFilter').value.toLowerCase();
        document.querySelectorAll('.performance-row').forEach(row => {
            const nameMatch = row.dataset.name.includes(term);
            const gradeMatch = !grade || row.dataset.grade === grade;
            row.style.display = (nameMatch && gradeMatch) ? '' : 'none';
        });
    });
});
</script>
{% endblock %}
